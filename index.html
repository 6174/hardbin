<!doctype html>
<html>
<head>
<title>HardBin</title>
<link rel="stylesheet" href="bootstrap.min.css">
<link rel="stylesheet" href="prettify.css">
<link rel="stylesheet" href="hardbin.css">
</head>
<body>
<div id="container">
<div id="nav">
    <div id="title-div">
        <h1>HardBin</h1>
    </div>

    <div id="status-div">
        IPFS status: <span id="status">Loading...</span>
    </div>

    <div id="about-div">
        Created by jes.
    </div>

    <div id="controls-div">
        <a class="btn btn-default" href=".">Create new paste</a>
        <button class="btn btn-primary" id="top-save">Save &#128274;</button>
        <button class="btn btn-primary" id="top-edit" style="display:none">Edit &#128274;</button>
    </div>

</div>

<div style="clear:both"></div>

<div id="input-div">
    <div style="display:none" id="display-div"><pre id="display" class="prettyprint"></pre></div>
    <div id="textarea-div"><textarea autofocus rows="10" class="form-control" id="input" placeholder="Type or paste your text here, then click Save."></textarea></div>
</div>
</div>

<div id="modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="modal-title">Modal title</h4>
          </div>
          <div class="modal-body" id="modal-body">
            Modal body.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
    </div>
</div>

<script src="jquery-3.2.1.min.js"></script>
<script src="bootstrap.min.js"></script>
<script src="run_prettify.js"></script>
<script src="aes.js"></script>
<script type="text/javascript">
function set_status(txt) {
    $('#status').text(txt);
}

function modal(title, bodyhtml) {
    $('#modal-title').text(title);
    $('#modal-body').html(bodyhtml);
    $('#modal').modal('show');
}

function write(content, cb) {
    $.ajax({
        url: "content",
        type: "DELETE",
        success: function(data, status, xhr) {
            $.ajax({
                url: "/ipfs/" + xhr.getResponseHeader('Ipfs-Hash') + "/content",
                type: "PUT",
                data: content,
                success: function(data, status, xhr) {
                    cb(xhr.getResponseHeader('Ipfs-Hash'));
                },
                timeout: function() {
                    cb("");
                },
                error: function() {
                    cb("");
                },
            });
        },
        timeout: function() {
            cb("");
        },
        error: function() {
            cb("");
        },
    });
}

function check_writability() {
    set_status("Checking writability...");
    write("testing 123", function(hash) {
        if (hash) {
            set_status("Ready.");
        } else if (is_local_gateway()) {
            modal("IPFS Gateway Problem", "<p>It looks like you're viewing this over a local gateway. That's good! That's the safest way. But your gateway is not currently writable, which means you won't be able to save your work.</p><p>Kill it and relaunch with <tt>--writable</tt> if you want to save your work:</p><p><pre><code>$ ipfs daemon --writable</code></pre></p>");
            // TODO: add button to check again, or run check_writability in a timer (but don't pop up repeated modals)
            set_status("Sorry, it looks like the gateway is not writable (local gateway).");
        } else {
            // TODO: check if we can fetch ipfs content from http://localhost:8080/ and offer it as an option if so
            modal("IPFS Gateway Problem", "<p>This IPFS gateway is not writable, which means you won't be able to save your work.</p><p>If you want to save your work, you can either:</p><p>1. view this on the public writable gateway at <a href=\"https://hardbin.com/ipfs/$hash/#frag\">hardbin.com</a>, or</p><p>2. <a href=\"https://ipfs.io/docs/install/\">install IPFS</a>, run a local node, and then view this on your local node at <a href=\"http://localhost:8080/ipfs/$hash/#frag\">localhost:8080</a>.</p>");
            // TODO: add button to check again, or run check_writability in a timer (but don't pop up repeated modals)
            set_status("Sorry, it looks like the gateway is not writable (public gateway).");
        }
    });
}

function is_local_gateway() {
    return window.location.hostname == 'localhost';
}

function render(content) {
    $('#display').text(content);
    $('#input').val(content);

    $('#display').removeClass('prettyprinted');
    PR.prettyPrint();

    $('#display-div').show();
    $('#textarea-div').hide();
    $('#top-save').hide();
    $('#top-edit').show();
}

function unrender() {
    $('#display-div').hide();
    $('#textarea-div').show();
    $('#top-save').show();
    $('#top-edit').hide();
}

function load_content() {
    if (window.location.hash) {
        set_status("Loading encrypted content...");
        key = window.location.hash;
        key = key.replace('#','');
        $.ajax({
            url: "content",
            success: function(data) {
                // TODO: show an error if we couldn't decrypt the content
                render(decrypt(data,key));
                set_status("Ready.");
            },
        });
    }
}

function generate_key() {
    var alphabet = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    var k = '';
    for (var i = 0; i < 32; i++) {
        k += alphabet.charAt(Math.random()*alphabet.length);
    }
    return k;
}

function encrypt(data, key) {
    return CryptoJS.AES.encrypt(data, key).toString();
}

function decrypt(data, key) {
    return CryptoJS.AES.decrypt(data, key).toString(CryptoJS.enc.Utf8);
}

$('#top-save').click(function() {
    var key = generate_key();
    write(encrypt($('#input').val(), key), function(hash) {
        if (!hash) {
            set_status("Failed to store content. Perhaps the gateway isn't writable?");
        } else {
            window.location = '/ipfs/' + hash + '#' + key;
        }
    });
});

$('#top-edit').click(function() {
    unrender();
});

$(document).ready(function() {
    // TODO: only check_writability now if there's no content; otherwise only
    // check it once they start editing
    check_writability();
    load_content();
});
</script>
</body>
</html>
