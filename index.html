<!doctype html>
<html>
<head>
<title>Trustful Bin</title>
<link rel="stylesheet" href="/ipfs/QmPEJx9Bur2NNDPtBNT5zQ6bBnCkgYtKeNBAWRXx4j5hf2/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <h1>Trustful Bin</h1>

    <span id="status">Loading...</span>

    <textarea class="form-control" id="input"></textarea>
    <button class="btn btn-primary" id="save">Save</button>
</div>

<script src="/ipfs/QmVvNwVXecuvQtKxwPuL1L58UPh9EYDU5iQSLjeN3S2sto/jquery-3.2.1.min.js"></script>
<script src="/ipfs/QmPEJx9Bur2NNDPtBNT5zQ6bBnCkgYtKeNBAWRXx4j5hf2/js/bootstrap.min.js"></script>
<script src="aes.js"></script>
<script type="text/javascript">
function set_status(txt) {
    $('#status').text(txt);
}

function write(content, cb) {
    $.ajax({
        url: "content",
        type: "DELETE",
        success: function(data, status, xhr) {
            $.ajax({
                url: "/ipfs/" + xhr.getResponseHeader('Ipfs-Hash') + "/content",
                type: "PUT",
                data: content,
                success: function(data, status, xhr) {
                    cb(xhr.getResponseHeader('Ipfs-Hash'));
                },
                timeout: function() {
                    cb("");
                },
                error: function() {
                    cb("");
                },
            });
        },
        timeout: function() {
            cb("");
        },
        error: function() {
            cb("");
        },
    });
}

function check_writability() {
    set_status("Checking writability...");
    write("testing 123", function(hash) {
        if (hash) {
            set_status("Ready.");
        } else if (is_local_gateway()) {
            set_status("Sorry, it looks like the gateway is not writable (local gateway).");
        } else {
            set_status("Sorry, it looks like the gateway is not writable (public gateway).");
        }
    });
}

function is_local_gateway() {
    return window.location.hostname == 'localhost';
}

function load_content() {
    if (window.location.hash) {
        set_status("Loading encrypted content...");
        key = window.location.hash;
        key = key.replace('#','');
        $.ajax({
            url: "content",
            success: function(data) {
                $('#input').val(decrypt(data, key));
                set_status("Ready.");
            },
        });
    }
}

function generate_key() {
    var alphabet = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    var k = '';
    for (var i = 0; i < 32; i++) {
        k += alphabet.charAt(Math.random()*alphabet.length);
    }
    return k;
}

function encrypt(data, key) {
    return CryptoJS.AES.encrypt(data, key).toString();
}

function decrypt(data, key) {
    return CryptoJS.AES.decrypt(data, key).toString(CryptoJS.enc.Utf8);
}

$('#save').click(function() {
    var key = generate_key();
    write(encrypt($('#input').val(), key), function(hash) {
        if (!hash) {
            set_status("Failed to store content. Perhaps the gateway isn't writable?");
        } else {
            window.location = '/ipfs/' + hash + '#' + key;
        }
    });
});

$(document).ready(function() {
    check_writability();
    load_content();
});
</script>
</body>
</html>
